#!/usr/bin/env sh
# Commit message validation hook
# Checks commit message format using commitlint
# Also validates ASCII-only characters

set -e

echo "ğŸ” Validating commit message..."

# First, check for ASCII-only characters
COMMIT_MSG_FILE="$1"
if [ -f "$COMMIT_MSG_FILE" ]; then
    # Check if commit message contains non-ASCII characters (bytes > 127)
    # Use LC_ALL=C and od to check for bytes outside ASCII range (0x00-0x7F)
    if LC_ALL=C od -An -tx1 "$COMMIT_MSG_FILE" 2>/dev/null | LC_ALL=C grep -q '[89abcdef][0-9a-f]'; then
        # Found bytes >= 0x80 (non-ASCII)
        echo "âŒ Commit message contains non-ASCII characters"
        echo "ğŸ’¡ Use only ASCII characters (0x00-0x7F)"
        echo "ğŸ’¡ Non-ASCII characters (Unicode, emoji, special chars) are not allowed"
        exit 1
    fi
fi

# Check if npx is available
if ! command -v npx >/dev/null 2>&1; then
    echo "âš ï¸  npx not found, skipping commitlint check"
    echo "ğŸ’¡ Install Node.js to enable commit message validation"
    exit 0
fi

# Check if commitlint is installed (try local first, then npx)
COMMITLINT_CMD=""
if [ -f "node_modules/.bin/commitlint" ]; then
    # Use local commitlint
    COMMITLINT_CMD="node_modules/.bin/commitlint"
elif npx commitlint --version >/dev/null 2>&1; then
    # Use npx commitlint
    COMMITLINT_CMD="npx commitlint"
fi

if [ -z "$COMMITLINT_CMD" ]; then
    echo "âš ï¸  commitlint not found, skipping check"
    echo "ğŸ’¡ Run 'npm install' to install commitlint"
    exit 0
fi

# Validate commit message (suppress errors if dependencies are missing)
if ! $COMMITLINT_CMD --edit "$1" 2>/dev/null; then
    # If commitlint fails, check if it's due to missing dependencies
    # Check if node_modules/@commitlint directory exists (more reliable than checking specific file)
    if [ -f "package.json" ] && [ ! -d "node_modules/@commitlint" ]; then
        echo "âš ï¸  commitlint dependencies not installed, skipping check"
        echo "ğŸ’¡ Run 'npm install' to install commitlint dependencies"
        exit 0
    fi
    # If it's a real validation error, fail
    echo "âŒ Commit message validation failed"
    exit 1
fi

echo "âœ… Commit message is valid"
