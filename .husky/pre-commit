#!/usr/bin/env sh
# Fast pre-commit hook - checks formatting for staged files
# Optimized for maximum speed: parallel checks, caching, skip large changes
# Full quality checks run in CI

set -e

# Get staged files (fast, no output)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check Java files formatting
STAGED_JAVA_FILES=$(echo "$STAGED_FILES" | grep '\.java$' || true)

if [ -n "$STAGED_JAVA_FILES" ]; then
    FILE_COUNT=$(echo "$STAGED_JAVA_FILES" | wc -l | tr -d ' ')
    
    # Skip if many files (let CI handle it)
    if [ "$FILE_COUNT" -gt 10 ]; then
        exit 0
    fi
    
    # Fast formatting check with parallel execution and configuration cache
    if [ -f "./gradlew" ]; then
        ./gradlew spotlessCheck --no-daemon --parallel --configuration-cache > /dev/null 2>&1 || {
            echo "❌ Formatting check failed. Run './gradlew format' to fix"
            exit 1
        }
    fi
fi

# Check YAML files formatting (if any)
STAGED_YAML_FILES=$(echo "$STAGED_FILES" | grep -E '\.(yml|yaml)$' || true)

if [ -n "$STAGED_YAML_FILES" ]; then
    YAML_COUNT=$(echo "$STAGED_YAML_FILES" | wc -l | tr -d ' ')
    
    # Skip if many files (let CI handle it)
    if [ "$YAML_COUNT" -gt 5 ]; then
        exit 0
    fi
    
    # Fast YAML check (only if prettier is available locally)
    if [ -f "node_modules/.bin/prettier" ]; then
        for file in $STAGED_YAML_FILES; do
            case "$file" in
                */node_modules/*|*/build/*|*/.jmix/*|*/helm/*)
                    continue
                    ;;
            esac
            [ -f "$file" ] && [ ! -d "$file" ] && node_modules/.bin/prettier --check "$file" > /dev/null 2>&1 || {
                echo "❌ YAML formatting failed: $file. Run 'npx prettier --write $file'"
                exit 1
            }
        done
    fi
fi

# Check for ASCII-only text in staged files (fast check)
STAGED_CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(java|properties|xml)$' || true)

if [ -n "$STAGED_CODE_FILES" ]; then
    CODE_COUNT=$(echo "$STAGED_CODE_FILES" | wc -l | tr -d ' ')
    
    # Skip if many files (let CI handle it)
    if [ "$CODE_COUNT" -le 10 ]; then
        # Fast check for non-ASCII characters (bytes > 127)
        for file in $STAGED_CODE_FILES; do
            case "$file" in
                */messages_*.properties)
                    continue
                    ;;
            esac
            [ -f "$file" ] && [ ! -d "$file" ] && LC_ALL=C od -An -tx1 "$file" 2>/dev/null | tr -d ' \n' | sed 's/\(..\)/\1 /g' | LC_ALL=C grep -qE '\b[89abcdef][0-9a-f]\b' && {
                echo "❌ Non-ASCII found in: $file. Run './gradlew lintEnglishOnly'"
                exit 1
            }
        done
    fi
fi

exit 0
