#!/usr/bin/env sh
# Fast pre-commit hook - checks formatting for staged files
# Optimized for speed: only checks changed files, not entire codebase
# Full quality checks run in CI

set -e

echo "ğŸ” Running pre-commit checks..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM || true)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No files to check"
    exit 0
fi

# Check Java files formatting
STAGED_JAVA_FILES=$(echo "$STAGED_FILES" | grep '\.java$' || true)

if [ -n "$STAGED_JAVA_FILES" ]; then
    FILE_COUNT=$(echo "$STAGED_JAVA_FILES" | wc -l | tr -d ' ')
    echo "ğŸ“ Checking formatting for $FILE_COUNT Java file(s)..."
    
    # Quick check: if many files, skip (let CI handle it)
    if [ "$FILE_COUNT" -gt 10 ]; then
        echo "âš ï¸  Many files changed ($FILE_COUNT), skipping format check"
        echo "ğŸ’¡ CI will run full format check"
    else
        # Check formatting for staged Java files only
        if command -v ./gradlew >/dev/null 2>&1; then
            echo "ğŸ” Checking code formatting..."
            ./gradlew spotlessCheck --no-daemon > /dev/null 2>&1 || {
                echo "âŒ Code formatting check failed"
                echo "ğŸ’¡ Run './gradlew format' to fix formatting issues"
                exit 1
            }
            echo "âœ… Formatting check passed"
        else
            echo "âš ï¸  gradlew not found, skipping format check"
        fi
    fi
fi

# Check YAML files formatting (if any)
STAGED_YAML_FILES=$(echo "$STAGED_FILES" | grep -E '\.(yml|yaml)$' || true)

if [ -n "$STAGED_YAML_FILES" ]; then
    YAML_COUNT=$(echo "$STAGED_YAML_FILES" | wc -l | tr -d ' ')
    echo "ğŸ“ Checking formatting for $YAML_COUNT YAML file(s)..."
    
    if command -v npx >/dev/null 2>&1; then
        YAML_CHECK_FAILED=0
        for file in $STAGED_YAML_FILES; do
            if [ -f "$file" ] && [ ! -d "$file" ]; then
                # Skip node_modules, build, .jmix, helm
                case "$file" in
                    */node_modules/*|*/build/*|*/.jmix/*|*/helm/*)
                        continue
                        ;;
                esac
                
                if ! npx prettier --check "$file" > /dev/null 2>&1; then
                    echo "âŒ YAML formatting check failed for: $file"
                    echo "ğŸ’¡ Run 'npx prettier --write $file' to fix"
                    YAML_CHECK_FAILED=1
                fi
            fi
        done
        
        if [ "$YAML_CHECK_FAILED" -eq 1 ]; then
            exit 1
        fi
        echo "âœ… YAML formatting check passed"
    fi
fi

# Check for non-English text in staged files (quick check)
STAGED_CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(java|properties|xml)$' || true)

if [ -n "$STAGED_CODE_FILES" ]; then
    CODE_COUNT=$(echo "$STAGED_CODE_FILES" | wc -l | tr -d ' ')
    echo "ğŸ“ Checking for English-only text in $CODE_COUNT code file(s)..."
    
    # Quick check: if many files, skip (let CI handle it)
    if [ "$CODE_COUNT" -gt 10 ]; then
        echo "âš ï¸  Many files changed ($CODE_COUNT), skipping English-only check"
        echo "ğŸ’¡ CI will run full English-only check"
    else
        # Quick check for Cyrillic in staged files
        VIOLATIONS_FOUND=0
        for file in $STAGED_CODE_FILES; do
            if [ -f "$file" ] && [ ! -d "$file" ]; then
                # Skip messages_ru.properties (Russian localization is allowed)
                case "$file" in
                    */messages_ru.properties)
                        continue
                        ;;
                esac
                
                # Check for Cyrillic characters
                if grep -q "[Ğ-Ğ¯Ğ°-ÑĞÑ‘]" "$file" 2>/dev/null; then
                    echo "âŒ Non-English text found in: $file"
                    echo "ğŸ’¡ Code must contain only English text"
                    VIOLATIONS_FOUND=1
                fi
            fi
        done
        
        if [ "$VIOLATIONS_FOUND" -eq 1 ]; then
            echo "âŒ English-only check failed"
            echo "ğŸ’¡ Run './gradlew lintEnglishOnly' for detailed report"
            exit 1
        fi
        echo "âœ… English-only check passed"
    fi
fi

echo "âœ… Pre-commit checks passed"
exit 0
