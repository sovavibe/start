#!/usr/bin/env sh
# Fast pre-commit hook - checks formatting for staged files
# Optimized for speed: only checks changed files, not entire codebase
# Full quality checks run in CI

set -e

echo "ğŸ” Running pre-commit checks..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM || true)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No files to check"
    exit 0
fi

# Check Java files formatting
STAGED_JAVA_FILES=$(echo "$STAGED_FILES" | grep '\.java$' || true)

if [ -n "$STAGED_JAVA_FILES" ]; then
    FILE_COUNT=$(echo "$STAGED_JAVA_FILES" | wc -l | tr -d ' ')
    echo "ğŸ“ Checking formatting for $FILE_COUNT Java file(s)..."
    
    # Quick check: if many files, skip (let CI handle it)
    if [ "$FILE_COUNT" -gt 10 ]; then
        echo "âš ï¸  Many files changed ($FILE_COUNT), skipping format check"
        echo "ğŸ’¡ CI will run full format check"
    else
        # Check formatting for staged Java files only
        if command -v ./gradlew >/dev/null 2>&1; then
            echo "ğŸ” Checking code formatting..."
            ./gradlew spotlessCheck --no-daemon > /dev/null 2>&1 || {
                echo "âŒ Code formatting check failed"
                echo "ğŸ’¡ Run './gradlew format' to fix formatting issues"
                exit 1
            }
            echo "âœ… Formatting check passed"
        else
            echo "âš ï¸  gradlew not found, skipping format check"
        fi
    fi
fi

# Check YAML files formatting (if any)
STAGED_YAML_FILES=$(echo "$STAGED_FILES" | grep -E '\.(yml|yaml)$' || true)

if [ -n "$STAGED_YAML_FILES" ]; then
    YAML_COUNT=$(echo "$STAGED_YAML_FILES" | wc -l | tr -d ' ')
    echo "ğŸ“ Checking formatting for $YAML_COUNT YAML file(s)..."
    
    if command -v npx >/dev/null 2>&1; then
        echo "$STAGED_YAML_FILES" | while read -r file; do
            if [ -f "$file" ] && [ ! -d "$file" ]; then
                # Skip node_modules, build, .jmix, helm
                case "$file" in
                    */node_modules/*|*/build/*|*/.jmix/*|*/helm/*)
                        continue
                        ;;
                esac
                
                npx prettier --check "$file" > /dev/null 2>&1 || {
                    echo "âŒ YAML formatting check failed for: $file"
                    echo "ğŸ’¡ Run 'npx prettier --write $file' to fix"
                    exit 1
                }
            fi
        done
        echo "âœ… YAML formatting check passed"
    fi
fi

echo "âœ… Pre-commit checks passed"
exit 0
