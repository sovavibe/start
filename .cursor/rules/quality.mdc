---
globs: ["**/entity/**/*.java", "**/view/**/*.java", "**/service/**/*.java", "**/test/**/*.java", "**/*Test*.java", "**/security/**/*.java", "**/config/**/*.java", "application*.yml", "application*.properties", "build.gradle", "config/**/*.xml", "config/**/*.properties", ".baseline/**"]
version: "4.0.0"
---

# CODE QUALITY & SUPPRESSION POLICY

## PRINCIPLES
**Vibe Coding**: Minimal suppressions, maximum code quality | **Token Economy**: Optimize suppression usage | **Framework-Specific**: Only suppress Jmix/Vaadin/Lombok false positives | **Inline First**: SonarLint suppressions are inline (visible, local, documented) | **Baseline**: Use Baseline out-of-the-box, do NOT customize unless absolutely necessary | ❌ Do NOT override Baseline-managed versions (Error Prone, Checkstyle, PMD, SpotBugs) | ✅ Let Baseline manage everything

## CODE QUALITY STANDARDS
**Java 21**: Virtual threads, pattern matching, records (5+ params → Builder), text blocks | **Metrics**: Limits: 250 lines/file, 10 cyclomatic, 10 cognitive complexity | If exceeded: Refactor (extract methods, split files) | Formatting: 120 chars/line (Palantir Style Guide standard), Palantir Java Format (Spotless via Baseline) | Suppressions: Document why, fix root cause | Reference: [Palantir Java Style Guide](https://github.com/palantir/gradle-baseline/blob/develop/docs/java-style-guide/readme.md) | **FQN Check**: Rule: `AvoidFullyQualifiedNames` (Checkstyle RegexpSinglelineJava) | ⚠️ NOT ENABLED BY DEFAULT in Palantir Baseline | Location: `.baseline/checkstyle/checkstyle.xml` (TreeWalker section) - needs to be added manually | Pattern: Universal - catches any FQN pattern `package.subpackage.Class` (minimum 2 dots) | Exclusions: Imports and package declarations automatically excluded | Suppression: `@SuppressWarnings("checkstyle:avoidfullyqualifiednames")` if truly necessary (rare) | Note: This rule is enforced via AI rules (`@core.mdc` → AI ASSISTANT BEHAVIOR) and code review, not by Checkstyle | **Standards**: SOLID, Clean Architecture, DRY, KISS | Final fields, immutable | Constructor injection | @Nullable/@NonNull | Validation: @Email, @NotNull, @Size | Senior+ level: production-ready, maintainable, testable | **Spring & Env**: @Configuration, @Bean | @Transactional (service, readOnly) | ❌ System.getenv() → ✅ @Value("${app.key:default}") | Profiles: application-{profile}.yml | ❌ Secrets in code → env vars | **Import Order**: Automatically enforced by `com.palantir.baseline` via Spotless: 1) `java.*` (Java standard library) | 2) `javax.*` (Legacy Java extensions) | 3) `jakarta.*` (Jakarta EE) | 4) `org.*` (Third-party libraries: Spring, Jmix, etc.) | 5) `com.*` (All com.* imports grouped together, includes project imports) | 6) Static imports last | Note: Baseline groups all `com.*` together (including `com.digtp.*`). This is acceptable per Baseline defaults | Rules: ✅ Java stdlib → Framework (Spring/Jmix) → Project → Static imports | ✅ Blank line between groups, no blank lines within group | ✅ Alphabetical within each group

## WHEN TO SUPPRESS
**Inline @SuppressWarnings** (Required for PMD and SonarLint): PMD: Always required (Baseline limitation - cannot centralize) | SonarLint: Always required (inline suppressions are visible, local, documented) | Other tools: Only when central config doesn't cover the case | **Requirements**: ✅ Always include justification comment explaining WHY | ✅ Be specific: Use exact rule name (`PMD.RuleName`, `java:S110`, `checkstyle:rulename`) | ✅ Minimal scope: method > class > package | ✅ Framework-specific only: Jmix/Vaadin/Lombok patterns, not general code quality | ✅ Format: Use array format for multiple rules with comments | **Format**: One rule: `// Comment explaining WHY` + `@SuppressWarnings("PMD.RuleName")` | Several rules: `@SuppressWarnings({// Comment, "PMD.Rule1", // Comment, "PMD.Rule2"})` | **Centralized Configs** (XML/Non-Java Files Only): Where: `sonar-project.properties` (SonarLint/SonarQube) - XML files only (xml:S2068 for UI labels) | `config/spotbugs/exclude.xml` (SpotBugs) - EclipseLink, framework lifecycle | `.baseline/checkstyle/custom-suppressions.xml` (Checkstyle) - Lombok, framework patterns | **Requirements**: Narrow scope (package patterns), documented, framework-only | **When to use**: XML files (cannot use inline annotations) | SpotBugs patterns (EclipseLink, framework lifecycle) | Checkstyle patterns (Lombok, framework patterns) | **IMPORTANT**: SonarLint suppressions are now inline in Java code for visibility and documentation! | **❌ NEVER Global Rule Disabling**: Forbidden: PMD custom rulesets overriding Baseline, global Checkstyle suppressions, Error Prone disabling without justification | Why: Loses Baseline advantages, hides real bugs

## SUPPRESSION HIERARCHY
1. **Fix the code** - Best, no suppression needed
2. **Inline @SuppressWarnings** - Visible, local, documented (required for PMD and SonarLint)
3. **Central config (narrow scope)** - XML files, SpotBugs, Checkstyle patterns only
4. **Global rule disabling** - ❌ NEVER (except Baseline-managed)

**IMPORTANT**: SonarLint: Use inline `@SuppressWarnings` in Java code (visible, local, documented) | PMD: Must use inline `@SuppressWarnings` (Baseline limitation, cannot centralize) | SpotBugs: Use central config (`config/spotbugs/exclude.xml`) for EclipseLink patterns | Checkstyle: Use central config (`.baseline/checkstyle/custom-suppressions.xml`) for Lombok patterns | XML files: Use central config in `sonar-project.properties` (cannot use inline annotations)

## FRAMEWORK PATTERNS
**Jmix/Vaadin Views**: S110, S2177, S1948, S2150, S1186, S6813, S1172 → Inline: `@SuppressWarnings({"java:S110", ...})` | PMD.NonSerializableClass → Inline: `@SuppressWarnings("PMD.NonSerializableClass")` | PMD.FieldDeclarationsShouldBeAtStartOfClass → Inline: `@SuppressWarnings("PMD.FieldDeclarationsShouldBeAtStartOfClass")` | **Framework Interfaces**: PMD.LongVariable, PMD.FormalParameterNamingConventions → Inline: `@SuppressWarnings("PMD.RuleName")` | **Tests**: S5738, S5976, S5853, S4144, S1130 → Inline: `@SuppressWarnings({"java:S5738", ...})` | **Unused variables**: java:S117 → Inline: `@SuppressWarnings("java:S117")` (Error Prone conflict) | **XML files**: xml:S2068 → Central: `sonar-project.properties` | **Lombok**: AtLeastOneConstructor, javadoc → Central: `.baseline/checkstyle/custom-suppressions.xml` | **EclipseLink**: ES/EI patterns → Central: `config/spotbugs/exclude.xml` | **Test Reflection**: PMD.AvoidAccessibilityAlteration → Fixed: Use `ReflectionTestUtils.invokeMethod()` instead | **Lombok & Baseline**: Palantir Baseline does NOT have built-in Lombok support. Lombok generates code at compile time, while Baseline tools analyze compiled code. **Explicit suppressions are required** for Lombok-generated patterns | **Checkstyle**: MissingJavadocMethod and JavadocVariable for entity/DTO classes - Pattern: `.*/entity/.*\.java$|.*/dto/.*\.java$|.*Entity\.java$|.*Dto\.java$` in `.baseline/checkstyle/custom-suppressions.xml` | **SpotBugs**: EI/EI2/EI_EXPOSE_REP/EI_EXPOSE_REP2 for entity classes - Pattern: `~com\.digtp\.start\.entity\..*` in `config/spotbugs/exclude.xml` | **Sonar**: MissingJavadocMethod for `**/*Entity.java,**/*Dto.java,**/*Record.java` in `config/sonar-project.properties` | **PMD**: No suppressions needed - Baseline defaults already account for Lombok patterns. Use `@SuppressWarnings("PMD.RuleName")` locally when needed | **Annotation Processor Order**: Lombok must be FIRST: `annotationProcessor 'org.projectlombok:lombok'` (before Error Prone, NullAway) | **Best Practices**: ✅ Use `@RequiredArgsConstructor` for constructor injection | ✅ Use `@Getter/@Setter` for simple accessors | ✅ Use package/file patterns for suppressions (not global) | ❌ Don't suppress all warnings globally for Lombok | ❌ Don't use `@Data` on classes with business logic | ❌ Don't mix Lombok with manual code (getter + `@Getter`)

## BASELINE CONFIGURATION
**Applied Plugins**: `com.palantir.baseline` (6.76.0) - Checkstyle, PMD, SpotBugs, Spotless auto-config | `com.palantir.baseline-idea` (6.76.0) - IntelliJ IDEA config | `com.palantir.baseline-exact-dependencies` (6.76.0) - checkUnusedDependencies, checkImplicitDependencies | `com.palantir.baseline-error-prone` (6.76.0) - Error-prone static analysis | `com.palantir.baseline-class-uniqueness` (6.76.0) - Check duplicate classes | `com.palantir.baseline-prefer-project-modules` (6.76.0) - Prefer project modules | **Checkstyle**: Baseline manages via `.baseline/checkstyle/checkstyle.xml` | Custom suppressions in `.baseline/checkstyle/custom-suppressions.xml` (NOT `checkstyle-suppressions.xml` - auto-generated) | **PMD**: ✅ Baseline defaults (DO NOT use `ruleSetFiles` - overrides Baseline), suppress via `@SuppressWarnings("PMD.RuleName")` | **SpotBugs**: Baseline defaults, only specific exclusions for Lombok/Jmix in `config/spotbugs/exclude.xml` | **Formatting**: Command: `./gradlew format` (Baseline format task) | Spotless: Baseline auto-configures `importOrder`, `removeUnusedImports`, `trimTrailingWhitespace`, `endWithNewline` | Additional: `cleanthat()`, `formatAnnotations()`, `lineEndings = 'UNIX'`, `palantirJavaFormat('2.68.0')` | Priority: Auto-format takes precedence over Checkstyle indentation | **Checkstyle Suppressions**: Per-line/block: `@SuppressWarnings("checkstyle:rulename")` (lowercase, without "Check") | Comments: `// CHECKSTYLE:OFF` ... `// CHECKSTYLE:ON` (for IllegalImport, etc.) | File-level: `.baseline/checkstyle/custom-suppressions.xml` (NOT `checkstyle-suppressions.xml`) | **Update**: `./gradlew baselineUpdateConfig` - updates `.baseline/checkstyle/checkstyle.xml` and `checkstyle-suppressions.xml` (does NOT overwrite `custom-suppressions.xml`) | **Best Practices**: ✅ Use Baseline out-of-the-box | ✅ Use `./gradlew format` before commit | ✅ Suppressions only in `custom-suppressions.xml` | ✅ Format code first, then suppress only when necessary | ✅ **PMD**: Use Baseline defaults, suppress via `@SuppressWarnings("PMD.RuleName")` (DO NOT use `ruleSetFiles`) | ✅ **SpotBugs**: Use Baseline defaults, add only specific exclusions for Lombok/Jmix | ✅ **Error Prone**: Use Baseline-managed version, only disable specific checkers for framework patterns | ✅ **Lombok**: See `@lombok-baseline-integration.mdc` | ❌ **NEVER** override Baseline-managed versions | ❌ **NEVER** use `pmd { ruleSetFiles = ... }` | ❌ **NEVER** customize Baseline configurations unless framework-specific suppressions are needed

## QUICK DECISION TREE (AI)
1. **Framework annotation?** (@Bean, @Subscribe, @Install, @Component, etc.) → ✅ Central config (Error Prone ExcludedAnnotations)
2. **Generated code?** (Lombok, EclipseLink) → ✅ Central config (package patterns)
3. **Test code?** (*Test.java) → ✅ Central config (class patterns)
4. **Legitimate issue?** → ❌ Fix code, don't suppress

## QUALITY GATES & MAINTENANCE
CI fails on violations: `ignoreFailures = false` | Coverage: 85% instruction, 75% branch, 90% line | Review on Baseline/framework updates, consolidate duplicates
