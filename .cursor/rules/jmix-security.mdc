---
globs: ["**/security/**/*.java", "**/entity/**/*User*.java", "**/view/**/*Login*.java"]
autoFix: true
version: "1.1.0"
---

# JMIX SECURITY

## ENTITY SECURITY
@SystemLevel for system entities (User, Role) | @Secret for password fields | DataManager enforces row-level security | JmixUserDetails for authentication

## RESOURCE ROLES (@ResourceRole)
✅ Define roles as interfaces with @ResourceRole | ✅ Use @EntityPolicy for CRUD | ✅ Use @EntityAttributePolicy for attributes | ✅ Use @ViewPolicy for screens | ✅ Use @MenuPolicy for menu | ✅ Use @SpecificPolicy for custom | ✅ SecurityScope.UI for UI-only roles

**Example:**
```java
@ResourceRole(name = "Full Access", code = "system-full-access")
public interface FullAccessRole {
    @EntityPolicy(entityName = "*", actions = {EntityPolicyAction.ALL})
    @EntityAttributePolicy(entityName = "*", attributes = "*", action = EntityAttributePolicyAction.MODIFY)
    @ViewPolicy(viewIds = "*")
    @MenuPolicy(menuIds = "*")
    void fullAccess();
}
```

## ROW-LEVEL ROLES (@RowLevelRole)
✅ Use @RowLevelRole for instance-level restrictions | ✅ Use @PredicateRowLevelPolicy with JPQL | ✅ Use @JpqlRowLevelPolicy for complex queries

**Example:**
```java
@RowLevelRole(name = "Department Documents", code = "dept-docs")
public interface DepartmentDocumentsRole {
    @PredicateRowLevelPolicy(entityClass = Document.class, 
        where = "{E}.department.id = :current_user_department_id")
    void documents();
}
```

## USER REPOSITORY
✅ Extend AbstractDatabaseUserRepository<User> | ✅ Override initSystemUser() / initAnonymousUser() | ✅ Use @Primary @Component("userRepository") | ✅ Set authorities via getGrantedAuthoritiesBuilder()

## AUTHENTICATION
✅ Use `LoginViewSupport.authenticate(AuthDetails)` in login views | ✅ Use `CurrentAuthentication` to get current user | ✅ Use `AuthDetails.of(username, password).withLocale().withRememberMe()` | ✅ Handle: BadCredentialsException, DisabledException, LockedException, AccessDeniedException

## AUTHORIZATION
✅ Use `CurrentAuthentication.getUser()` / `isAuthenticated()` / `getAuthorities()` | ✅ DataManager enforces permissions automatically | ✅ Use `SystemAuthenticator` for system operations

## USER MANAGEMENT
✅ User implements `JmixUserDetails` | ✅ Use `@Secret` for password | ✅ Use `@SystemLevel` for system entities | ✅ Implement: `isEnabled()`, `isAccountNonExpired()`, `isAccountNonLocked()`, `isCredentialsNonExpired()`

## PASSWORD MANAGEMENT
✅ Always use `PasswordEncoder.encode()` before saving | ✅ Never store plain text | ✅ Format: `{encoder}encodedPassword` (e.g., `{bcrypt}$2a$10...`, `{noop}plain` dev only) | ✅ Validate confirmation in UI | ✅ Use standard actions: `sec_changePassword`, `sec_resetPassword`

**Formats**: `{bcrypt}$2a$10...` (production), `{noop}plain` (dev only, NEVER production), `{pbkdf2}...` | Spring Security auto-detects prefix

## SECURITY FILTER CHAIN
✅ Use @Order(JmixSecurityFilterChainOrder.CUSTOM) for custom endpoints | ✅ Define SecurityFilterChain beans in @Configuration | ✅ Use securityMatcher() for URL patterns

## ROLE AUTHORITY PREFIXES
✅ Customize via `GrantedAuthorityDefaults` bean | ✅ Default: `ROLE_{roleCode}` (resource), `RL_{roleCode}` (row-level)

## UI COMPONENT POLICIES (Optional Add-on)
✅ Use `@UiComponentPolicy` in resource roles | ✅ Requires `jmix-uiconstraints` add-on | ✅ Policies are "denying" - can only restrict | ✅ Applied after ReadyEvent

## SESSION MANAGEMENT
✅ Use `SessionData` for session-scoped data | ✅ Use `UserSessions` (Audit add-on) for active sessions | ✅ Remember Me: `AuthDetails.withRememberMe(true)`

## SECURITY TESTING
✅ Use `@ExtendWith(AuthenticatedAsAdmin.class)` for system auth | ✅ Use `SystemAuthenticator.begin(username)` / `end()` manually | ✅ Test via DataManager operations (access denied exceptions)

## EXTERNAL AUTHENTICATION (Optional)
✅ OIDC add-on for OpenID Connect | ✅ LDAP add-on for LDAP/Active Directory | ✅ External IAM manages users/roles | ✅ Application maps external to internal roles

## SECURITY SERVICES
**SystemAuthenticator**: ✅ Use `begin(username)` / `end()` in finally block | ✅ Use in background tasks, scheduled jobs, tests

**CurrentUserSubstitution**: ✅ Use `setSubstitutedUser(username)` / `clearSubstitution()` | ✅ Requires proper permissions | ✅ Use for support/debugging

**Runtime/Database Roles**: ✅ Defined at runtime, stored in SEC_ROLE table | ✅ Use SEC_ROLE_ASSIGNMENT for user-role assignments | ✅ UI available for management
