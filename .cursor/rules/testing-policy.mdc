---
globs: ["**/test/**/*.java", "**/*Test*.java", "**/*IT.java"]
autoFix: true
version: "8.1.0"
---

# TESTING

## PRINCIPLE
NEVER DELETE FAILING TESTS! Fix the reason, not the test.

## WHEN FAILS
✅ Investigate → Root cause → ASK USER if external dependency → FIX → Run | ❌ Delete | @Disabled | Comment out

## COMMON FAILURES
TestContainers: Docker not running → Ask user start Docker | NEVER delete integration tests | Missing Dependencies: Implement or wait

## EXCEPTIONS FOR DELETION
User requests | Duplicate | Removed feature | Better replacement | If all NO → DON'T DELETE

## TEST TYPES

### Unit Tests
**Annotations**: `@Test` only | **Pattern**: No Spring context, mock dependencies | **Use**: Pure logic, calculations, validators

### Integration Tests
**Annotations**: `@SpringBootTest` + `@ExtendWith({SpringExtension.class, AuthenticatedAsAdmin.class})` | **Pattern**: Full Spring context, `@Autowired` fields allowed | **Use**: Service layer, DataManager, security, transactions | **Cleanup**: `@AfterEach` with `dataManager.remove()`

### UI Integration Tests
**Annotations**: `@UiTest` + `@SpringBootTest(classes = {Application.class, FlowuiTestAssistConfiguration.class})` | **Dependencies**: `io.jmix.flowui:jmix-flowui-test-assist` | **Pattern**: `UiTestUtils.getCurrentView()`, `UiTestUtils.getComponent(view, "id")`, `button.click()`, `field.setValue()` | **Use**: View navigation, form interactions, DataGrid | **Helper**: Use `getCurrentViewAsView()` from `AbstractIntegrationTest` instead of `(View<?>) UiTestUtils.getCurrentView()`

### E2E Tests (Optional)
**Dependencies**: `io.jmix.masquerade:masquerade-core`, `masquerade-app` | **Pattern**: Page Object, Selenium/Selenide | **Use**: Full workflows, browser interactions | **Note**: Slower, use sparingly

## SPRING BOOT + JMIX PATTERNS

### Annotations
- **Unit**: `@Test` only
- **Integration**: `@SpringBootTest` + `@ExtendWith({SpringExtension.class, AuthenticatedAsAdmin.class})`
- **UI**: `@UiTest` + `@SpringBootTest(classes = {Application.class, FlowuiTestAssistConfiguration.class})`
- **@Autowired** fields allowed in tests (Spring Boot standard)

### Jmix Extensions
- `@ExtendWith({SpringExtension.class, AuthenticatedAsAdmin.class})` - SpringExtension first (init context), AuthenticatedAsAdmin second (admin security)
- AuthenticatedAsAdmin auto-sets admin user, cleans up after

### Test Structure (AAA/GWT)
**REQUIRED**: Every test MUST follow AAA (Arrange-Act-Assert) or GWT (Given-When-Then) with explicit comments:
- `// Arrange (Given)` - Setup test data, mocks
- `// Act (When)` - Execute code under test (single action)
- `// Assert (Then)` - Verify outcome (multiple assertions OK)

**Rules**: Clear section separation, one action in Act, multiple assertions OK

### Assertions & Cleanup
- **AssertJ**: `assertThat(actual).isEqualTo(expected)` (auto-available in Jmix)
- **Cleanup**: `@AfterEach` with `dataManager.remove(entity)` or queries
- **Test Data**: Unique identifiers (`"test-user-" + System.currentTimeMillis()`), cleanup patterns (`"test-%"`)

### DataManager in Tests
- ✅ `dataManager.create(Entity.class)` - create
- ✅ `dataManager.save(entity)` - save
- ✅ `dataManager.load(Entity.class).id(id).one()` - load by ID
- ✅ `dataManager.remove(entity)` - delete
- ✅ Queries for cleanup: `dataManager.load(Entity.class).query("e.field like ?1", "test-%").list()`

## TESTCONTAINERS
**Pattern**: @Testcontainers abstract BaseIntegrationTest | @Container static PostgreSQLContainer withReuse(true) | @DynamicPropertySource configureProperties | @SpringBootTest @Transactional extends BaseIntegrationTest

**Performance**: testcontainers.reuse.enable=true (2-5s startup) | @Transactional rollback | Singleton container (NOT per test)

**Antipatterns**: New container per test → singleton | @DirtiesContext everywhere → slow | No reuse → slow
