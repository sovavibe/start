---
globs: ["src/main/**/*.java", "src/test/**/*.java"]
autoFix: false
version: "2.0.0"
---

# LOGGING POLICY

## PRINCIPLES
**Observability First**: Logs are the eyes of the system. Removing logs = loss of observability.
**Structured Logging**: Always use parameterized messages, never concatenation.
**Context Matters**: Always log important context (userId, entityId, operation, requestId).
**Security**: Never log passwords, tokens, secrets, PII (except audit.log with masking).

## LOG LEVELS

**DEBUG**: Detailed diagnostics, method tracing, internal states. Does NOT affect production (INFO level). Example: `log.debug("User entity initialized: isNew={}, username={}", isNew, username);`

**INFO**: Business events (entity CRUD, successful operations), component start/stop, state changes. Example: `log.info("User created: id={}, username={}", user.getId(), user.getUsername());`

**WARN**: Issues that don't break functionality, validation failed (expected), retry operations, deprecated API. Example: `log.warn("Login failed: username={}, reason={}", username, reason);`

**ERROR**: Critical errors, exceptions, operations that cannot be executed, system errors. Example: `log.error("Failed to save user: id={}, username={}", user.getId(), user.getUsername(), exception);`

## STRUCTURED LOGGING

✅ **Correct**: `log.info("User created: id={}, username={}", user.getId(), user.getUsername());`
❌ **Incorrect**: `log.info("User created: id=" + user.getId());` // Concatenation
❌ **Incorrect**: `log.info("User created");` // No context

## WHEN NOT TO REMOVE LOGS

**CRITICAL**: Do NOT remove logs for:
1. **Configuration/initialization**: Config loading, component init, app start/stop, DB migrations
2. **Error handling**: Catch blocks (always log exceptions), validation failed, retry operations
3. **Business events**: Entity CRUD, authentication (success/failure), critical operations
4. **Diagnostics**: DEBUG logs for internal states, execution tracing, call parameters

**Rule**: If logging helps understand what's happening - do NOT remove it.

## SECURITY

❌ **Never log**: Passwords (plain/hashed), tokens (JWT, API keys, sessions), secrets, PII without masking (except audit.log), SQL with secret parameters.

✅ **Safe**: `log.info("User authenticated: username={}", username);`
❌ **Never**: `log.info("User authenticated: password={}", password);`

## CONTEXT (MDC)

Always use MDC for request context: `requestId` (UUID), `userId` (if authenticated), `sessionId` (optional). Example: `MDC.put("requestId", UUID.randomUUID().toString());` - clear in `finally` block.

## AUDIT LOGGING

Use separate logger `com.digtp.start.audit` for business events (entity CRUD, authentication, critical operations, security changes). Example: `LoggerFactory.getLogger("com.digtp.start.audit").info("USER_CREATED: userId={}, username={}", userId, username);`

## PERFORMANCE

Log slow operations (>100ms services, >500ms views) at DEBUG level. Don't log in hot paths unnecessarily. Use `log.isDebugEnabled()` before expensive operations.

## ANTIPATTERNS

❌ **Removing logs for "cleanliness"**: `if (isEmpty()) return;` → ✅ `if (isEmpty()) { log.debug("..."); return; }`
❌ **No context**: `log.info("User created");` → ✅ `log.info("User created: id={}, username={}", id, username);`
❌ **Concatenation in loop**: `log.debug("User: " + user);` → ✅ `log.debug("User: username={}", username);`

## CHECKLIST

Before removing/changing a log: Does it help understand the system? Used for diagnostics? Contains context (userId, entityId, operation)? Business event or error? **If yes → keep it.**

## ERROR LOGGING

**CRITICAL**: Always log exceptions in catch blocks with context. Example: `log.error("Operation failed: entityId={}, username={}", entityId, username, exception);`

**Best Practices**: ✅ Include exception as last parameter | ✅ Include context (entityId, userId, operation) | ✅ ERROR for unexpected, WARN for expected | ❌ Never swallow silently | ❌ Never use `printStackTrace()` or `System.out.println()`

## SUMMARY

Observability First | Structured Logging (parameterized) | Context Matters | Security (no secrets) | Don't Remove Logs | Use Right Level (DEBUG/INFO/WARN/ERROR) | MDC for Tracing | Audit for Business | Always Log Exceptions
